/* Theresa's Sound World 0.0.1 (c) 2013 Stuart Memo */
window.tsw=function(e,t){var n=function(e,t){for(attr in t)e[attr]=t[attr];return e},r=function(e){return Array.isArray(e)},a=function(e){var t=!1;return Object(e)&&"node"in e&&(t=!0),t},o=function(e){return e.hasOwnProperty("context")},i=function(e){return e.hasOwnProperty("input")||e.hasOwnProperty("output")},c={};c.version="0.0.1",c.processors=[],c.isBrowserCompatible=!1;var u=function(e,n){if("undefined"==typeof webkitAudioContext&&"undefined"==typeof AudioContext)if(webkitAudioContext.prototype.createGainNode===t)n("Sorry, your browser doesn't support a recent enough version of the Web Audio API.");else{var r=webkitAudioContext.prototype;r.createGain=r.createGainNode,r.createDelay=r.createDelayNode,r.createScriptProcessor=r.createJavaScriptNode}else c.context="function"==typeof AudioContext?new AudioContext:new webkitAudioContext;c.isBrowserCompatible=!0,e()},s=function(){c.speakers=c.context.destination};return c.now=function(){return this.context.currentTime},c.createChannelMerger=function(e){return c.context.createChannelMerger(e)},c.connect=function(){for(var e=function(){arguments[0].connect(arguments[1])},t=function(){arguments[0].connect(arguments[1].input)},n=function(){for(var e=0;arguments[1].length>e;e++)c.connect(arguments[0],arguments[1][e])},u=function(){for(var e=0;arguments[0].length>e;e++)c.connect(arguments[0][e],arguments[1])},s=function(){arguments[0].output.connect(arguments[1])},f=function(){for(var e=0;arguments[0].length>e;e++)this.connect(arguments[0][e],arguments[1])},l=function(){for(var e=0;arguments[0].length>e;e++)this.connect(arguments[0][e],arguments[1])},p=function(){arguments[0].node.connect(arguments[1].node,arguments[0].channel,arguments[1].channel)},h=0;arguments.length-1>h;h++){var v=arguments[h],m=arguments[h+1];o(v)&&i(m)?t(v,m):i(v)&&o(m)?s(v,m):o(v)&&r(m)?n(v,m):r(v)&&o(m)?u(v,m):o(v)&&o(m)?e(v,m):i(v)&&i(m)?connectTswNode(v,m):i(v)&&r(m)?connectTswNodeToArray(v,m):r(v)&&i(m)?f(v,m):r(v)&&r(m)?l(v,m):a(v)&&r(m)?connectObjectWithNodeToArray(v,m):r(v)&&a(m)?connectArrayToObjectWithNode(v,m):a(v)&&a(m)&&p(v,m)}},c.disconnect=function(){for(var e=arguments.length,t=0;e>t;t++)arguments[t].disconnect()},c.load=function(e,t,n){var r={},a=this,o=function(e,t,n,r){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){filesLoaded++,a.context.decodeAudioData(o.response,function(t){n[e]=a.context.createBufferSource(),n[e].buffer=t,n[e].play=function(){a.play(this)},n[e].stop=function(){a.stop(this)},n[e].isPlaying=function(){return this.playbackState},filesLoaded===numberOfFiles&&r(n)})},o.send()};if("object"==typeof t)for(var i in t)numberOfFiles++,o(i,t[i],r,n);else{if("string"!=typeof t)throw Error("Files must be an array or a valid string.");numberOfFiles=1,o(i,t[i],r,n)}},c.createDelay=function(e){var t=this.context.createDelay();return t.delayTime.value=e||0,t},c.createMonoMaker=function(){var e={};return e.input=c.createGain(),e.output=c.createGain(),c.connect(e.input,e.output),e},c.createPanner=function(e){var t={},n=c.createGain(1),r=c.createGain(0),a=c.createChannelMerger(2);return t.input=c.createGain(),t.output=c.createGain(),t.value=e,t.value>1?t.value=1:-1>t.value&&(t.value=-1),n.gain.value=1-100*.01*((1+t.value)/2),r.gain.value=1-n.gain.value,c.connect(t.input,[n,r]),c.connect({node:n,channel:0},{node:a,channel:0}),c.connect({node:r,channel:0},{node:a,channel:1}),c.connect(a,t.output),t},c.play=function(e,t){t=t||0,e.start(t)},c.stop=function(e,t){t=t||0,e.stop(t)},c.reverse=function(e){for(var t=0;e.buffer.numberOfChannels>t;t++)Array.prototype.reverse.call(e.buffer.getChannelData(t));return e},c.createOscillator=function(e,n){var r=this.context.createOscillator();return r.start===t&&(r.start=r.noteOn,r.stop=r.noteOff),e=e||"SINE",e=e.toUpperCase(),r.type=r[e],r.safariType=e.toLowerCase(),r.frequency.value=n||440,r},c.createGain=function(e){var t;return t="function"==typeof this.context.createGain?this.context.createGain():this.context.createGainNode(),t.gain.value=e||1,t},c.createBuffer=function(){var e=this.context.createBuffer(1,65536,44100);return e},c.createBufferSource=function(e){var t=this.context.createBufferSource();return t.buffer=e,t},c.createFilter=function(e,t,n){var r=e||"lowpass",a=this.context.createBiquadFilter();return a.type=r,a.frequency.value=t||0,a.Q.value=n||0,a},c.createAnalyser=function(){return this.context.createAnalyser()},c.createCompressor=function(e){var t=this.context.createDynamicsCompressor(),r={threshold:-24,knee:30,ratio:12,attack:.003,release:.25};return e=n(r,e),this.applySettings(t,e),t},c.createProcessor=function(e,t){var n=e||1024,r=c.context.createScriptProcessor(n,1,1);return"function"==typeof t&&(r.onaudioprocess=function(e){t(e)}),r},c.createWaveShaper=function(){for(var e=new Float32Array(65536),t=0;32768>t;t++)e[t]=3e4>t?.1:-1;var n=this.context.createWaveShaper();return n.curve=e,n},c.createEnvelope=function(e){var n={},e=e||{};return n.startLevel=e.startLevel||0,n.maxLevel=e.maxLevel||1,n.minLevel=e.minLevel||0,n.attackTime=e.attackTime||1,n.decayTime=e.decayTime||1,n.sustainLevel=e.sustainLevel||1,n.releaseTime=e.releaseTime||1,n.param=e.param||{},n.param.value=n.startLevel,n.autoStop=e.autoStop===t?!0:e.autoStop,n.start=function(e){this.maxLevel=this.startLevel+this.maxLevel,this.sustainLevel=this.startLevel+this.sustainLevel,console.log(this.attackTime);var t=e||c.now(),n=t+this.attackTime,r=n+this.decayTime,a=r+this.releaseTime;this.param.cancelScheduledValues(t),this.param.setValueAtTime(this.startLevel,t),this.param.linearRampToValueAtTime(this.maxLevel,n),this.param.linearRampToValueAtTime(this.startLevel+this.sustainLevel,r),console.log(n-c.now()),this.autoStop&&(this.param.linearRampToValueAtTime(this.minLevel,a),this.stop(a))},n.stop=function(e){e=e||c.now(),e+=this.releaseTime,this.autoStop||this.param.linearRampToValueAtTime(this.minLevel,this.releaseTime)},n},c.createNoise=function(){for(var e,t=this.createBuffer(),n=0;65536>n;n++)t.getChannelData(0)[n]=2*Math.random()-1;return e=this.createBufferSource(t),e.loop=!0,e},c.createLFO=function(e){var t=c.createOscillator(),r=this.createGain(),a={frequency:0,waveType:"triangle",depth:1,target:null,autoStart:!1};return e=n(a,e),t.type=t[e.waveType]||t.TRIANGLE,r.gain.value=e.depth,t.frequency.value=e.frequency,e.autoStart&&t.start(c.now()),t.modulate=function(e){this.connect(r),r.connect(e)},t.setWaveType=function(e){t.type=t[e.toUpperCase()]},t.setFrequency=function(e){t.frequency.value=e},t.setDepth=function(e){r.gain.value=e},t.modulate(e.target),t},c.getUserAudio=function(e){var t=function(t){var n=c.context.createMediaStreamSource(t);e(n)};navigator.webkitGetUserMedia({audio:!0},t)},function(){u(function(){s()},function(e){console.log(e)})}(),c}(window),function(){tsw.createDelay=function(e){var t={},n=tsw.context.createDelay(),r=tsw.context.createGain(),a=tsw.context.createGain(),o=tsw.createGain();return t.input=tsw.createGain(),t.output=tsw.createGain(),t.settings={delayTime:.5,feedback:.5,effectLevel:.5},e=e||{},n.delayTime.value=e.delayTime||t.settings.delayTime,r.gain.value=e.feedback||t.settings.feedback,a.gain.value=e.effectLevel||t.settings.effectLevel,tsw.connect(t.input,o,n,r,n,a,t.output),tsw.connect(o,n),t},tsw.createDistortion=function(e){var t={},n=context.createWaveShaper(),r=context.createBiquadFilter(),a=context.createBiquadFilter();return t.settings={distortionLevel:.5},e=e||{},t.input=tsw.createGain(),t.output=tsw.createGain(),tsw.connect(t.input,n,[r,a],t.output),t},tsw.createFlanger=function(){var e={};return e},tsw.createPhaser=function(e){var t={},n=[],r=tsw.createGain(),a={rate:8,depth:.5,feedback:.8};e=e||{},r.gain.value=e.gain||a.gain;for(var o=0;config.rate>o;o++)n[o]=tsw.context.createBiquadFilter(),n[o].type=7,n[o].frequency.value=100*o;t.input=tsw.createGain(),t.output=tsw.createGain();for(var o=0;n.length-1>o;o++)tsw.connect(n[o],n[o+1]);return tsw.connect(t.input,n[0],n[n.length-1],r,n[0]),tsw.connect(n[n.length-1],t.output),t.setCutoff=function(){for(var e=0;n.length>e;e++);},t},tsw.createReverb=function(e){var t=tsw.context.createConvolver(),n=tsw.createGain(),r={},a={effectLevel:.5,reverbTime:.5,reverbType:"spring",reverbPath:""};return e=e||{},n.gain.value=e.effectLevel||a.effectLevel,tsw.load({hall:"/effects/reverb/responses/bright-hall.wav",room:"/effects/reverb/responses/medium-room.wav",spring:"/effects/reverb/responses/feedback-spring.wav"},function(e){a.reverbPath=e[a.reverbType],t.buffer=a.reverbPath,r.input=tsw.createGain(),r.output=tsw.createGain(),tsw.connect(r.input,[r.output,t]),tsw.connect(t,n),tsw.connect(n,r.output)}),r},tsw.createTremolo=function(e){var t={},n=(tsw.createGain(),this.createLFO()),r=this;return e=e||{},t.input=tsw.createGain(),t.connect=function(e){t.input.connect(e),n.modulate(t.input.gain),n.start(r.now())},t.setRate=function(e){n.setFrequency(e)},t.setDepth=function(e){n.setDepth(e)},t}}(window),function(){var e=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];e.push.apply(e,e);var t=["unison","flat 2nd","2nd","minor 3rd","major 3rd","perfect 4th","flat 5th","perfect 5th","minor 6th","major 6th","minor 7th","major 7th","octave","flat 9th","9th","sharp 9th","major 10th","11th","augmented 11th","perfect 12th","flat 13th","13th"],n=function(t){for(var n=e.length,r=0;n>r;r++)if(t.toUpperCase()===e[r])return positionOnScale=r,r;return null},r=function(t){var r=[],a=n(t);return r.push(e[a]),r.push(e[a+2]),r.push(e[a+4]),r.push(e[a+5]),r.push(e[a+7]),r.push(e[a+9]),r.push(e[a+11]),r.push(e[a+12]),r},a=function(t){var r=[],a=n(t);return r.push(e[a]),r.push(e[a+2]),r.push(e[a+3]),r.push(e[a+5]),r.push(e[a+7]),r.push(e[a+8]),r.push(e[a+10]),r.push(e[a+12]),r};tsw.parseChord=function(t){var r={},a=[],o=0;return Array.isArray(t)?!1:(t=t.toLowerCase(),r.rootNote=t[0].toUpperCase(),r.isMajor=t.indexOf("maj")>-1,r.isMinor=!r.isMajor&&t.indexOf("m")>-1,r.is7th=t.indexOf("7")>-1,r.notes=[],r.is7th||(r.octave=t.match(/\d/g)),r.isMajor||r.isMinor?(o=n(r.rootNote),a.push(o),t.isMinor?a.push(o+getSemitoneDifference("minor 3rd")):a.push(o+getSemitoneDifference("major 3rd")),a.push(o+getSemitoneDifference("perfect 5th")),a.push(o+getSemitoneDifference("octave")),a.forEach(function(t){r.notes.push(e[t])}),r.notes):!1)},tsw.getScale=function(e,t){return"minor"===t?a(e):r(e)},tsw.getSemitoneDifference=function(e){for(var n=t.length,r=0;n>r;r++)if(e===t[r])return r},tsw.isChord=function(e){return this.parseChord(e)},tsw.chordToNotes=function(e){return e=this.parseChord(e),e.notes},tsw.noteToFrequency=function(t){var n,r;return n=3===t.length?t.charAt(2):t.charAt(1),r=e.indexOf(t.slice(0,-1)),r=3>r?r+12+12*(n-1)+1:r+12*(n-1)+1,Math.round(440*Math.pow(2,(r-49)/12))}}(window),function(e){var t=function(){var e=function(e){this.context=e};return e.prototype.getUserMIDI=function(e,t){navigator.requestMIDIAccess().then(e,t)},e.prototype.MIDINumberToNote=function(e){var t=e%12,n=Math.floor(e/12),r=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return r[t]+n},e}();e.tsw.midi=new t}(window);